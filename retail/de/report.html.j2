<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <title>Weekly Sales Briefing</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    .wrap { max-width: 960px; margin: 0 auto; background:#fff; }
    .header { background:#000; color:#fff; padding:20px 40px; display:flex; align-items:center; border-radius:8px 8px 0 0; }
    .logo { background:#ccc; color:#000; padding:7px 22px; margin-left:auto; }
    h2 { background:#ddd; padding:8px; margin:24px 0 8px; }
    table { border-collapse: collapse; width:100%; text-align:left; border:1px solid #ddd; font-size:13px; border-radius:8px; overflow:hidden; }
    th, td { border:1px solid #ddd; padding:6px 8px; }
    .section { padding:40px; }
    .footer { background:#000; color:#fff; text-align:center; font-size:12px; padding:10px 40px; border-radius:0 0 8px 8px; }
  </style>
</head>
<body>
  {# ---------- Format-Macros ---------- #}
  {% macro fmt0(x) -%}
    {%- if x is number -%}
      {{ "{:,.0f}".format(x) | replace(",", "'") }}
    {%- else -%}
      {{ "" }}
    {%- endif -%}
  {%- endmacro %}

  {% macro fmtpct(x) -%}
    {%- if x is number -%}
      {{ "{:.0f}%".format(x * 100) }}
    {%- else -%}
      {{ "" }}
    {%- endif -%}
  {%- endmacro %}

  {# --- Defensiver Zugriff auf Daten --- #}
  {% set week = (kpis.week | default({}, true)) %}
  {% set mtd  = (kpis.mtd  | default({}, true)) %}
  {% set ytd  = (kpis.ytd  | default({}, true)) %}

  <div class="wrap header">
    <div style="font-size:28px; font-weight:bold;">
      Weekly Sales Briefing ‚Äì KW {{ week.SalesWeekNr | default('‚Äì') }} - {{ week.SalesYear | default('‚Äì') }}
    </div>
    <div class="logo">Logo</div>
  </div>

  <div class="wrap section">
    <h2>üìä √úbersicht Kennzahlen</h2>
    <div style="overflow-x:auto;">
      <table>
        <thead style="background:#f2f2f2;">
          <tr>
            <th>Kennzahl</th><th>Woche</th><th>Woche PY</th><th>Œî</th><th>%</th>
            <th>MTD</th><th>MTD PY</th><th>Œî</th><th>%</th>
            <th>YTD</th><th>YTD PY</th><th>Œî</th><th>%</th>
          </tr>
        </thead>
        <tbody>
          {% macro row(label, w, m, y, base) -%}
            {% set wdiff = (w[base ~ 'Diff'] | default(None)) %}
            {% set mdiff = (m[base ~ 'Diff'] | default(None)) %}
            {% set ydiff = (y[base ~ 'Diff'] | default(None)) %}
            <tr>
              <td>{{ label }}</td>

              <td>{{ fmt0(w[base]) }}</td>
              <td>{{ fmt0(w[base ~ 'PY']) }}</td>
              <td style="color: {{ 'red' if (wdiff is number and wdiff < 0) else 'green' if (wdiff is number and wdiff > 0) else 'inherit' }}">
                {{ fmt0(wdiff) }}{{ ' ‚Üì' if (wdiff is number and wdiff < 0) else ' ‚Üë' if (wdiff is number and wdiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (wdiff is number and wdiff < 0) else 'green' if (wdiff is number and wdiff > 0) else 'inherit' }}">
                {{ fmtpct(w[base ~ '_ChangePct'] | default(None)) }}
              </td>

              <td>{{ fmt0(m[base]) }}</td>
              <td>{{ fmt0(m[base ~ 'PY']) }}</td>
              <td style="color: {{ 'red' if (mdiff is number and mdiff < 0) else 'green' if (mdiff is number and mdiff > 0) else 'inherit' }}">
                {{ fmt0(mdiff) }}{{ ' ‚Üì' if (mdiff is number and mdiff < 0) else ' ‚Üë' if (mdiff is number and mdiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (mdiff is number and mdiff < 0) else 'green' if (mdiff is number and mdiff > 0) else 'inherit' }}">
                {{ fmtpct(m[base ~ '_ChangePct'] | default(None)) }}
              </td>

              <td>{{ fmt0(y[base]) }}</td>
              <td>{{ fmt0(y[base ~ 'PY']) }}</td>
              <td style="color: {{ 'red' if (ydiff is number and ydiff < 0) else 'green' if (ydiff is number and ydiff > 0) else 'inherit' }}">
                {{ fmt0(ydiff) }}{{ ' ‚Üì' if (ydiff is number and ydiff < 0) else ' ‚Üë' if (ydiff is number and ydiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (ydiff is number and ydiff < 0) else 'green' if (ydiff is number and ydiff > 0) else 'inherit' }}">
                {{ fmtpct(y[base ~ '_ChangePct'] | default(None)) }}
              </td>
            </tr>
          {%- endmacro %}

          {{ row('Netto Umsatz', week, mtd, ytd, 'NetAmount') }}
          {{ row('Transaktionen', week, mtd, ytd, 'TransactionCnt') }}
          {{ row('Kunden',        week, mtd, ytd, 'CustomerCnt') }}
          {{ row('Menge',         week, mtd, ytd, 'Quantity') }}
        </tbody>
      </table>
    </div>

    <h2>üìù Zusammenfassung</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>Woche:</strong> {{ narrative.summaryWeek | default('') }}</p>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>MTD:</strong>   {{ narrative.summaryMTD | default('') }}</p>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>YTD:</strong>   {{ narrative.summaryYTD | default('') }}</p>

    <h2>üå§Ô∏è Wetter-Analyse</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;">{{ narrative.weather | default('') }}</p>

    {# --- Wetter-Chart (optional; ben√∂tigt weatherChart im Render-Context) --- #}
    {% if weatherChart %}
      <div style="margin: 12px 0 24px;">
        <canvas id="tempChart" height="120"></canvas>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
      (function() {
        const cfg = {{ weatherChart | tojson }};
        const ctx = document.getElementById('tempChart').getContext('2d');

        // Schwach transparente Hinterlegung f√ºr Sa/So
        const weekend = cfg.weekend || [];
        const weekendBg = {
          id: 'weekendBg',
          beforeDraw(chart, args, opts) {
            const {ctx, chartArea, scales:{x}} = chart;
            if (!chartArea || !x) return;
            ctx.save();
            ctx.globalAlpha = 0.06;
            ctx.fillStyle = '#000';
            weekend.forEach((isWknd, i) => {
              if (!isWknd) return;
              const labelsLen = (cfg.labels || []).length;
              const xCenter = x.getPixelForValue(i);
              const xPrev = x.getPixelForValue(Math.max(i - 1, 0));
              const xNext = x.getPixelForValue(Math.min(i + 1, labelsLen - 1));
              const left  = (i === 0) ? xCenter - (xNext - xCenter)/2 : (xCenter + xPrev)/2;
              const right = (i === labelsLen - 1) ? xCenter + (xCenter - xPrev)/2 : (xCenter + xNext)/2;
              ctx.fillRect(left, chartArea.top, right - left, chartArea.bottom - chartArea.top);
            });
            ctx.restore();
          }
        };

        const datasets = [];
        if (cfg.series && cfg.series[0]) {
          datasets.push({ label: cfg.series[0].name, data: cfg.series[0].data, spanGaps: true, tension: 0.25 });
        }
        if (cfg.series && cfg.series[1]) {
          datasets.push({ label: cfg.series[1].name, data: cfg.series[1].data, spanGaps: true, tension: 0.25 });
        }

        new Chart(ctx, {
          type: 'line',
          data: { labels: cfg.labels || [], datasets },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              tooltip: { intersect: false, mode: 'index' }
            },
            scales: {
              y: { title: { display: true, text: '¬∞C' } },
              x: { title: { display: true, text: 'Wochentage' } }
            },
            elements: { point: { radius: 3 } }
          },
          plugins: [weekendBg]
        });
      })();
      </script>
    {% endif %}

    <h2>üì¶ Sortiment & Empfehlungen</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;">{{ narrative.stock | default('') }}</p>
  </div>

  <div class="wrap footer">
    Dieses Briefing wurde automatisch erstellt. Bei Fragen wende dich an XXX.
  </div>
</body>
</html>
